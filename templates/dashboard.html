<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RL Radiologist | Operator Console</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- HEAVY MACHINE THEME --- */
        :root {
            --bg-color: #050505;       /* Pure Black */
            --panel-bg: #0f1115;       /* Dark Metal */
            --border-color: #333;      /* Dark Grey borders */
            --accent-cyan: #00f0ff;    /* Cyber Cyan */
            --accent-amber: #ffaa00;   /* Warning Amber */
            --text-main: #e0e0e0;
            --text-muted: #666;
            --font-ui: 'Segoe UI', system-ui, sans-serif;
            --font-mono: 'Consolas', 'Courier New', monospace; /* For that machine look */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            /* SCROLL FIX: Changed from height:100vh/overflow:hidden to min-height/auto */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto; 
            font-family: var(--font-ui);
            background-image: 
                linear-gradient(rgba(20, 20, 20, 0.5) 1px, transparent 1px),
                linear-gradient(90deg, rgba(20, 20, 20, 0.5) 1px, transparent 1px);
            background-size: 40px 40px; /* Subtle grid background */
        }

        /* --- TOP CONTROL DECK --- */
        header {
            background-color: var(--panel-bg);
            border-bottom: 2px solid var(--border-color);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            z-index: 100;
        }

        .brand-panel {
            display: flex; flex-direction: column;
            border-left: 4px solid var(--accent-cyan);
            padding-left: 15px;
        }
        .brand-name { font-family: var(--font-mono); font-weight: 700; font-size: 1.2rem; letter-spacing: 2px; color: var(--accent-cyan); text-transform: uppercase; }
        .brand-sub { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        .controls { display: flex; gap: 15px; align-items: center; }

        /* Tactical Inputs */
        input[type="file"] {
            background: #000;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            padding: 5px;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            cursor: pointer;
        }

        .slider-panel {
            background: #000; border: 1px solid var(--border-color);
            padding: 5px 15px; display: flex; align-items: center; gap: 10px;
            font-family: var(--font-mono); font-size: 0.8rem;
        }
        .slider-panel span { color: var(--accent-amber); }

        /* Power Button */
        button.primary-btn {
            background: linear-gradient(180deg, #222, #111);
            color: var(--accent-cyan);
            border: 1px solid var(--accent-cyan);
            padding: 10px 25px;
            text-transform: uppercase;
            font-family: var(--font-mono);
            font-weight: bold;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 240, 255, 0.1);
            transition: 0.2s;
        }
        button.primary-btn:hover {
            background: var(--accent-cyan);
            color: #000;
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.5);
        }

        /* --- MAIN CONSOLE GRID --- */
        #results {
            display: none; 
            grid-template-columns: 2fr 1fr; /* 2/3 Visuals, 1/3 Data */
            gap: 15px;
            padding: 15px;
            /* SCROLL FIX: Enforce minimum height so scrolling works on small screens */
            height: calc(100vh - 70px);
            min-height: 800px; 
        }

        .col { display: flex; flex-direction: column; gap: 15px; height: 100%; }

        /* --- MACHINE PANELS --- */
        .panel {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            position: relative;
            display: flex; flex-direction: column;
            /* The "cut corner" look */
            clip-path: polygon(
                0 0, 
                100% 0, 
                100% calc(100% - 15px), 
                calc(100% - 15px) 100%, 
                0 100%
            );
            padding: 2px; /* For inner border effect */
        }
        
        .panel-inner {
            background: #111;
            flex-grow: 1;
            display: flex; flex-direction: column;
            padding: 10px;
            height: 100%;
            clip-path: polygon(
                0 0, 
                100% 0, 
                100% calc(100% - 14px), 
                calc(100% - 14px) 100%, 
                0 100%
            );
        }

        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 5px;
        }
        .panel-label {
            font-family: var(--font-mono); font-size: 0.8rem;
            color: var(--accent-cyan); text-transform: uppercase;
            display: flex; align-items: center; gap: 8px;
        }
        .panel-status {
            width: 8px; height: 8px; background: #333; border-radius: 50%;
            box-shadow: 0 0 5px #333;
        }
        .panel-status.active { background: var(--accent-cyan); box-shadow: 0 0 8px var(--accent-cyan); }

        /* --- HUD IMAGE VIEWERS --- */
        .hud-display {
            background: #000;
            border: 1px solid #333;
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        
        /* Grid Overlay on Images */
        .hud-display::before {
            content: ''; position: absolute; top:0; left:0; right:0; bottom:0;
            background-image: 
                linear-gradient(rgba(0, 240, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 240, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none; z-index: 10;
        }
        
        /* Corner Brackets */
        .hud-display::after {
            content: ''; position: absolute; inset: 10px;
            border: 1px solid transparent;
            border-top: 2px solid var(--accent-cyan);
            border-bottom: 2px solid var(--accent-cyan);
            /* Just top/bottom edges simulation */
            mask: linear-gradient(90deg, black 20%, transparent 20%, transparent 80%, black 80%);
            pointer-events: none; z-index: 10;
        }

        .hud-display img { max-width: 100%; max-height: 100%; object-fit: contain; z-index: 1; }

        /* Playback Deck */
        .control-deck {
            margin-top: 10px; display: flex; gap: 10px; align-items: center;
            background: #050505; padding: 5px; border: 1px solid #333;
        }
        .deck-btn {
            background: #222; border: none; color: var(--text-main);
            width: 30px; height: 30px; cursor: pointer;
            font-size: 0.8rem; display: flex; align-items: center; justify-content: center;
        }
        .deck-btn:hover { background: var(--accent-cyan); color: #000; }
        
        input[type=range] {
            flex-grow: 1; height: 4px; background: #333; appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            appearance: none; width: 10px; height: 20px; background: var(--accent-cyan); cursor: pointer;
        }

        /* --- DATA TERMINAL --- */
        .terminal-text {
            font-family: var(--font-mono); font-size: 0.85rem; color: #aaa;
            line-height: 1.5; white-space: pre-wrap;
        }
        
        .log-entry {
            border-bottom: 1px solid #222; padding: 4px 0;
            display: flex; justify-content: space-between;
        }
        .log-time { color: var(--accent-cyan); margin-right: 10px; }

        /* Crops Grid */
        .crop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 5px; }
        .crop-tile {
            border: 1px solid #333; background: #000;
            display: flex; flex-direction: column;
        }
        .crop-tile img { width: 100%; height: 70px; object-fit: cover; filter: grayscale(0.5); }
        .crop-tile span {
            font-family: var(--font-mono); font-size: 0.6rem; 
            text-align: center; color: var(--accent-cyan); padding: 2px;
            background: #111;
        }

        /* --- LOADER --- */
        #loader {
            display: none; position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); text-align: center;
        }
        .scanner-line {
            width: 200px; height: 2px; background: var(--accent-cyan);
            box-shadow: 0 0 10px var(--accent-cyan);
            animation: scan 1s infinite alternate;
        }
        @keyframes scan { 0% { width: 10px; opacity: 0.5; } 100% { width: 200px; opacity: 1; } }
        
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-cyan); }
    </style>
</head>
<body>

    <header>
        <div class="brand-panel">
            <span class="brand-name">RL-RAD // <span style="font-weight: 400;">OPERATOR</span></span>
            <span class="brand-sub">Neural Diagnostic Console v2.0</span>
        </div>
        
        <div class="controls">
            <input type="file" id="fileInput" accept="image/*, .dcm">
            
            <div class="slider-panel">
                <i class="fa-solid fa-sliders"></i>
                <span>THR:</span>
                <input type="range" id="thresholdSlider" min="0.1" max="0.9" step="0.05" value="0.3">
                <span id="thresholdVal">0.30</span>
            </div>
            
            <button class="primary-btn" onclick="processImage()">
                INITIATE SCAN
            </button>
        </div>
    </header>

    <!-- System Loader -->
    <div id="loader">
        <div class="brand-name blink">PROCESSING DATA STREAM...</div>
        <div style="height: 20px; display: flex; align-items: center; justify-content: center; margin-top: 10px;">
            <div class="scanner-line"></div>
        </div>
    </div>

    <div id="results">
        <!-- LEFT: VISUALS -->
        <div class="col" style="flex: 2;">
            <!-- Main RL Viewer -->
            <div class="panel" style="flex: 2;">
                <div class="panel-inner">
                    <div class="panel-header">
                        <div class="panel-label">
                            <i class="fa-solid fa-layer-group"></i> RL AGENT VIEW
                        </div>
                        <div class="panel-label">
                            <span id="stepLabel">IDLE</span>
                            <div class="panel-status active"></div>
                        </div>
                    </div>
                    
                    <div class="hud-display">
                        <img id="editorImage" src="" alt="NO SIGNAL">
                    </div>

                    <div class="control-deck">
                        <button class="deck-btn" onclick="togglePlay()"><i id="playIcon" class="fa-solid fa-play"></i></button>
                        <input type="range" id="frameSlider" min="0" value="0" oninput="updateFrameFromSlider()">
                        <span class="panel-label" style="font-size: 0.7rem;">SEQ_CTRL</span>
                    </div>
                </div>
            </div>

            <!-- Comparison Grid -->
            <div class="panel" style="flex: 1;">
                <div class="panel-inner" style="flex-direction: row; gap: 10px;">
                    <div style="flex: 1; display: flex; flex-direction: column;">
                        <div class="panel-header">
                            <div class="panel-label">DETECTION HUD</div>
                        </div>
                        <div class="hud-display">
                            <img id="finalImage" src="">
                        </div>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column;">
                        <div class="panel-header">
                            <div class="panel-label">ATTENTION MAP</div>
                        </div>
                        <div class="hud-display">
                            <img id="heatmapImage" src="">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: DATA -->
        <div class="col" style="flex: 1;">
            
            <!-- LLM Analysis -->
            <div class="panel" style="height: 20%;">
                <div class="panel-inner">
                    <div class="panel-header">
                        <!-- RENAMED FROM GEMINI LINK -->
                        <div class="panel-label"><i class="fa-solid fa-microchip"></i> AI CORE LINK</div>
                    </div>
                    <div class="terminal-text" id="llmAdvice" style="color: var(--accent-amber);">
                        // WAITING FOR UPLINK...
                    </div>
                </div>
            </div>

            <!-- Report Terminal -->
            <div class="panel" style="flex: 1;">
                <div class="panel-inner">
                    <div class="panel-header">
                        <div class="panel-label">DIAGNOSTIC REPORT</div>
                    </div>
                    <div style="flex-grow: 1; overflow-y: auto; border: 1px solid #222; padding: 5px; background: #000;">
                        <pre id="reportText" class="terminal-text"></pre>
                    </div>
                    <div id="btnDownload" style="display: none; margin-top: 10px;">
                        <a href="/download_pdf" target="_blank" style="width: 100%;">
                            <button class="primary-btn" style="width: 100%; padding: 5px; font-size: 0.8rem;">
                                <i class="fa-solid fa-file-pdf"></i> EXPORT LOG
                            </button>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Crops -->
            <div class="panel" style="height: 25%;">
                <div class="panel-inner">
                    <div class="panel-header">
                        <div class="panel-label">TARGET ACQUISITION</div>
                    </div>
                    <div id="cropGallery" class="crop-grid" style="overflow-y: auto;">
                        <!-- Crops go here -->
                    </div>
                </div>
            </div>

            <!-- Logs -->
            <div class="panel" style="height: 15%;">
                <div class="panel-inner">
                    <div class="panel-header">
                        <div class="panel-label">SYS_LOG</div>
                    </div>
                    <div style="overflow-y: auto;" id="logList">
                        <!-- Logs go here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let frames = [], actions = [], timer, isPlaying = false;

        document.getElementById('thresholdSlider').oninput = (e) => document.getElementById('thresholdVal').innerText = parseFloat(e.target.value).toFixed(2);

        async function processImage() {
            const file = document.getElementById('fileInput').files[0];
            if(!file) { alert("SYSTEM ERROR: NO INPUT SOURCE DETECTED"); return; }
            
            // CLEANUP
            frames = []; actions = [];
            if(timer) clearInterval(timer);
            document.getElementById('cropGallery').innerHTML = '';
            document.getElementById('logList').innerHTML = '';
            document.getElementById('reportText').innerText = '';
            
            document.getElementById('loader').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('btnDownload').style.display = 'none';
            
            const fd = new FormData();
            fd.append('file', file);
            fd.append('threshold', document.getElementById('thresholdSlider').value);
            
            try {
                const res = await fetch('/process', {method:'POST', body:fd});
                const data = await res.json();
                
                frames = data.frames;
                actions = data.actions;
                
                // Text Updates
                document.getElementById('llmAdvice').innerText = `>> ${data.llm_advice}`;
                
                const logHTML = actions.map((a,i) => `
                    <div class="log-entry">
                        <span class="terminal-text" style="color:var(--text-main)">${a}</span>
                        <span class="terminal-text log-time">T+${i}s</span>
                    </div>`).join('');
                document.getElementById('logList').innerHTML = logHTML;

                document.getElementById('reportText').innerText = data.report;
                
                // Image Updates
                document.getElementById('finalImage').src = `data:image/jpg;base64,${data.final_result}`;
                document.getElementById('heatmapImage').src = `data:image/jpg;base64,${data.heatmap}`;
                
                // Crops
                const gal = document.getElementById('cropGallery');
                gal.innerHTML = '';
                if (data.crops && data.crops.length > 0) {
                    data.crops.forEach(c => {
                        gal.innerHTML += `
                            <div class="crop-tile">
                                <img src="data:image/jpg;base64,${c.img}">
                                <span>${c.name}</span>
                            </div>`;
                    });
                } else {
                    gal.innerHTML = '<span class="terminal-text">NO TARGETS</span>';
                }
                
                document.getElementById('btnDownload').style.display = 'block';
                
                // Init Editor
                document.getElementById('frameSlider').max = Math.max(0, frames.length - 1);
                updateFrame(0);
                
                document.getElementById('loader').style.display = 'none';
                document.getElementById('results').style.display = 'grid';
                play();
                
            } catch(e) { 
                alert("CRITICAL ERROR: " + e); 
                console.error(e);
                document.getElementById('loader').style.display = 'none'; 
            }
        }

        function updateFrame(i) {
            if(frames[i]) {
                document.getElementById('editorImage').src = `data:image/jpg;base64,${frames[i]}`;
                document.getElementById('stepLabel').innerText = `STEP [${i}]: ${actions[i] || 'COMPLETE'}`;
                document.getElementById('frameSlider').value = i;
            }
        }

        function updateFrameFromSlider() { pause(); updateFrame(parseInt(document.getElementById('frameSlider').value)); }
        function togglePlay() { isPlaying ? pause() : play(); }

        function play() {
            if(frames.length === 0) return;
            isPlaying = true;
            document.getElementById('playIcon').className = 'fa-solid fa-pause';
            let i = parseInt(document.getElementById('frameSlider').value);
            timer = setInterval(() => {
                i = (i + 1) % frames.length;
                updateFrame(i);
            }, 800);
        }

        function pause() {
            isPlaying = false;
            document.getElementById('playIcon').className = 'fa-solid fa-play';
            clearInterval(timer);
        }
    </script>
</body>
</html>